<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HQ - Pathfinder AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #EFF6FF; --bg-dark: #111827;
            --card-light: #FFFFFF; --card-dark: #1F2937;
            --text-light: #111827; --text-dark: #F9FAFB;
            --border-light: #1F2937; --border-dark: #F9FAFB;
            --accent-yellow: #FBBF24; --accent-blue: #3B82F6;
        }
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        body.dark-mode { background-color: var(--bg-dark); color: var(--text-dark); }
        body:not(.dark-mode) { background-color: var(--bg-light); color: var(--text-light); }
        h1, h2, h3 { font-family: 'Bangers', cursive; letter-spacing: 1.5px; }
        .comic-panel {
            background-color: var(--card-light);
            border: 3px solid var(--border-light);
            transition: all 0.3s;
        }
        .dark-mode .comic-panel { background-color: var(--card-dark); border-color: var(--border-dark); }
        .comic-sticker {
            background-color: var(--accent-yellow); color: black;
            transform: rotate(-3deg);
            display: inline-block;
            font-size: 1.5rem;
        }
        .dark-mode .comic-sticker { background-color: var(--accent-blue); color: white; }
        .custom-input { border: 2px solid #6B7280; }
        .comic-button { background-color: var(--accent-blue); border: 2px solid var(--border-light); box-shadow: 4px 4px 0px var(--border-light); transition: all 0.1s ease-in-out; }
        .dark-mode .comic-button { border-color: var(--border-dark); box-shadow: 4px 4px 0px var(--border-dark); }
        .comic-button:active { transform: translate(4px, 4px); box-shadow: none; }
        .modal-overlay { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="p-4">

<script>
    const token = localStorage.getItem('jwt_token');
    if (!token) { window.location.href = '/login.html'; }
    if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); }
</script>

<header class="comic-panel rounded-lg p-4 flex justify-between items-center mb-8">
    <h1 class="text-3xl">Pathfinder HQ</h1>
    <div class="flex items-center gap-4">
        <button id="theme-toggle" class="font-bold text-sm">TOGGLE THEME</button>
        <div id="profile-avatar" class="w-10 h-10 bg-blue-500 dark:bg-yellow-400 rounded-full cursor-pointer flex items-center justify-center font-bold text-white dark:text-black text-lg">?</div>
    </div>
</header>

<main class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
    <div class="lg:col-span-1">
        <div class="comic-panel rounded-lg p-6 sticky top-24">
            <h2 class="comic-sticker px-2 py-1 -mt-10 ml-2">Mission Briefing</h2>
            <form id="roadmap-form" class="mt-4 space-y-4">
                <div>
                    <label class="font-bold">Objective:</label>
                    <input type="text" id="topic" required class="w-full p-2 custom-input rounded-md" placeholder="e.g., Learn Quantum Physics">
                </div>
                <div>
                    <label class="font-bold">Skill Level:</label>
                    <select id="skillLevel" class="w-full p-2 custom-input rounded-md"><option>Beginner</option><option selected>Intermediate</option><option>Expert</option></select>
                </div>
                <div>
                    <label class="font-bold">Weekly Commitment:</label>
                    <input type="text" id="timeCommitment" required class="w-full p-2 custom-input rounded-md" placeholder="e.g., 8 hours">
                </div>
                <div>
                    <label class="font-bold">Total Timeframe:</label>
                    <input type="text" id="totalTimeframe" required class="w-full p-2 custom-input rounded-md" placeholder="e.g., 3 months">
                </div>
                <button type="submit" class="w-full py-2 font-bold text-xl tracking-wider comic-button rounded-md text-white">LAUNCH!</button>
            </form>
        </div>
    </div>

    <div id="dashboard-column" class="lg:col-span-2 space-y-8">
        <div id="initial-state" class="comic-panel rounded-lg p-8 text-center">
            <h3 class="text-2xl">Awaiting Your Mission</h3>
            <p>Fill out the briefing to get your roadmap!</p>
        </div>
        <div id="loading-indicator" class="hidden comic-panel rounded-lg p-8 text-center">
            <h3 class="text-2xl animate-pulse">ANALYZING INTEL...</h3>
        </div>
    </div>
</main>

<div id="profile-modal" class="hidden fixed inset-0 z-50 modal-overlay items-center justify-center">
    <div class="comic-panel bg-white dark:bg-gray-800 rounded-lg p-8 max-w-sm w-full text-center space-y-4">
        <h2 class="text-3xl">AGENT PROFILE</h2>
        <p id="user-email-display" class="font-bold text-lg bg-gray-200 dark:bg-gray-600 p-2 rounded"></p>
        <button id="logout-button" class="w-full py-2 font-bold text-xl comic-button rounded-md text-white !bg-red-500">LOGOUT</button>
        <button id="close-modal-button" class="text-sm text-gray-500 mt-2">Close</button>
    </div>
</div>

<script>
    // --- COMPLETE JAVASCRIPT LOGIC ---
    const userEmail = localStorage.getItem('user_email');

    // --- ELEMENT SELECTORS ---
    const themeToggle = document.getElementById('theme-toggle');
    const profileAvatar = document.getElementById('profile-avatar');
    const profileModal = document.getElementById('profile-modal');
    const closeModalButton = document.getElementById('close-modal-button');
    const logoutButton = document.getElementById('logout-button');
    const userEmailDisplay = document.getElementById('user-email-display');
    const roadmapForm = document.getElementById('roadmap-form');
    const resultsDashboard = document.getElementById('dashboard-column');
    const initialState = document.getElementById('initial-state');
    const loadingIndicator = document.getElementById('loading-indicator');

    let timelineChart = null;

    // --- THEME LOGIC ---
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    });

    // --- PROFILE MODAL LOGIC ---
    if (userEmail) {
        profileAvatar.textContent = userEmail.charAt(0).toUpperCase();
        userEmailDisplay.textContent = userEmail;
    }
    profileAvatar.addEventListener('click', () => profileModal.classList.remove('hidden'));
    closeModalButton.addEventListener('click', () => profileModal.classList.add('hidden'));
    logoutButton.addEventListener('click', () => {
        localStorage.clear();
        window.location.href = '/login.html';
    });

    // --- ROADMAP FORM SUBMISSION ---
    roadmapForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitButton = e.submitter;
        const originalButtonText = submitButton.textContent;
        submitButton.textContent = 'LAUNCHING...';
        submitButton.disabled = true;

        const requestData = {
            topic: document.getElementById('topic').value,
            skillLevel: document.getElementById('skillLevel').value,
            timeCommitment: document.getElementById('timeCommitment').value,
            totalTimeframe: document.getElementById('totalTimeframe').value
        };

        initialState.classList.add('hidden');
        resultsDashboard.innerHTML = '';
        loadingIndicator.classList.remove('hidden');
        resultsDashboard.appendChild(loadingIndicator);

        try {
            const response = await fetch('/api/v1/roadmaps/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(requestData)
            });

            if (response.status === 403) { window.location.href = '/login.html'; return; }
            if (!response.ok) { throw new Error('AI failed to generate intel. Mission aborted.'); }

            const roadmapData = JSON.parse(await response.text());
            displayRoadmap(roadmapData);

        } catch (error) {
            resultsDashboard.innerHTML = `<div class="comic-panel rounded-lg p-8 text-center text-red-500 font-bold">${error.message}</div>`;
        } finally {
            loadingIndicator.classList.add('hidden');
            submitButton.textContent = originalButtonText;
            submitButton.disabled = false;
        }
    });

    // --- DISPLAY LOGIC ---
    function displayRoadmap(data) {
        resultsDashboard.innerHTML = '';

        const summaryCard = document.createElement('div');
        summaryCard.className = 'comic-panel rounded-lg p-6';
        summaryCard.innerHTML = `<h2 class="comic-sticker px-2 py-1 -mt-10 ml-2">Mission Dossier</h2><h3 class="text-3xl mt-2">${data.mainGoal}</h3><p class="font-bold text-blue-500 dark:text-yellow-400">Total Duration: ${data.totalDuration}</p>`;
        resultsDashboard.appendChild(summaryCard);

        const chartCard = document.createElement('div');
        chartCard.className = 'comic-panel rounded-lg p-6';
        chartCard.innerHTML = `<h3 class="text-2xl mb-4">Phase Analysis</h3><canvas id="timelineChart"></canvas>`;
        resultsDashboard.appendChild(chartCard);
        renderTimelineChart(data.phases);

        data.phases.forEach(phase => {
            const phaseCard = document.createElement('div');
            phaseCard.className = 'comic-panel rounded-lg p-6 space-y-4';

            let topicsHtml = '';
            phase.topics.forEach(topic => {
                topicsHtml += `<tr class="border-b border-gray-200 dark:border-gray-600"><td class="py-2 pr-2"><p class="font-bold">${topic.topicName}</p><p class="text-sm text-gray-600 dark:text-gray-400">${topic.description}</p></td><td class="py-2 px-2 text-center font-bold">${topic.estimatedHours}h</td></tr>`;
            });

            phaseCard.innerHTML = `
                <div>
                    <h3 class="text-2xl text-blue-500 dark:text-yellow-400">${phase.phaseTitle}</h3>
                    <p class="font-bold text-sm text-gray-500">${phase.duration}</p>
                </div>
                <table class="w-full text-left text-sm"><tbody>${topicsHtml}</tbody></table>
                <div class="bg-gray-100 dark:bg-gray-800 border-2 border-dashed border-gray-300 dark:border-gray-600 p-4 rounded-lg">
                    <h4 class="font-bold text-lg">Field Project: ${phase.project.projectName}</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${phase.project.projectDescription}</p>
                </div>
            `;
            resultsDashboard.appendChild(phaseCard);
        });
    }

    // --- CHART RENDERING LOGIC ---
    function renderTimelineChart(phases) {
        if (timelineChart) { timelineChart.destroy(); }
        const ctx = document.getElementById('timelineChart').getContext('2d');
        const data = {
            labels: phases.map(p => p.duration),
            datasets: [{
                label: 'Est. Hours',
                data: phases.map(p => p.topics.reduce((sum, t) => sum + t.estimatedHours, 0)),
                backgroundColor: document.body.classList.contains('dark-mode') ? 'rgba(59, 130, 246, 0.7)' : 'rgba(251, 191, 36, 0.8)',
                borderColor: document.body.classList.contains('dark-mode') ? '#3B82F6' : '#FBBF24',
                borderWidth: 3
            }]
        };
        timelineChart = new Chart(ctx, {
            type: 'bar', data: data,
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: '#E5E7EB' }, ticks: { color: '#4B5563' } },
                    x: { grid: { color: '#E5E7EB' }, ticks: { color: '#4B5563' } }
                }
            }
        });
        if(document.body.classList.contains('dark-mode')){
            timelineChart.options.scales.y.grid.color = '#4B5563';
            timelineChart.options.scales.x.grid.color = '#4B5563';
            timelineChart.options.scales.y.ticks.color = '#D1D5DB';
            timelineChart.options.scales.x.ticks.color = '#D1D5DB';
            timelineChart.update();
        }
    }
</script>
</body>
</html>